{% set active_page = "annotate" %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annotate / Analog Data</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { outfit: ['Outfit', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'sans-serif'] },
          colors: {
            'tangerine-zest': '#f59e0b',
            'mellow-orange': '#fb923c',
            'deep-navy': '#0f172a',
            'brand-dark': '#0b0f19',
            'brand-light': '#f8fafc',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Outfit', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .btn-brand-sm {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 6px 16px; border-radius: 10px; font-weight: 600; font-size: 12px;
      background: linear-gradient(to right, #f59e0b, #fb923c, #fcd34d);
      border: 1px solid black; color: black;
      box-shadow: 0 4px 6px -1px rgba(251,191,36,0.2);
      transition: all 0.3s; cursor: pointer;
    }
    .btn-brand-sm:hover { filter: brightness(1.1); transform: scale(1.03); }
    .toast { transition: all 0.3s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    canvas { cursor: crosshair; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden">

  <!-- Topbar -->
  <div class="h-12 bg-white/95 backdrop-blur-md border-b border-slate-100 flex items-center px-4 gap-3 shrink-0">
    <!-- Logo + Gradient Bar -->
    <a href="/" class="flex items-center space-x-2 mr-3 hover:opacity-90 transition-opacity">
      <img src="https://cdn.analogdata.ai/static/images/logo/ad_logo.png" alt="Analog Data Logo" class="h-6 w-auto object-contain">
      <span class="block h-7 w-[3px] rounded-full bg-gradient-to-b from-amber-500 via-orange-400 to-amber-300 transform -skew-x-[15deg] shadow-[0_0_8px_rgba(251,146,60,0.5)]"></span>
      <div class="leading-tight">
        <div class="text-[10px] uppercase tracking-[0.2em] font-bold text-black/80">Analog Data</div>
        <div class="text-sm font-bold text-black">Annotator</div>
      </div>
    </a>

    <div class="h-5 w-px bg-slate-200"></div>

    <!-- Nav controls -->
    <button onclick="prevImage()" class="px-3 py-1.5 text-xs font-semibold bg-white border border-slate-200 text-slate-700 hover:border-amber-400 hover:text-slate-900 rounded-lg transition-all duration-300">
      <i class="fa-solid fa-arrow-left mr-1 text-[10px]"></i> Prev
    </button>
    <span id="counter" class="text-xs text-slate-500 bg-slate-100 px-2.5 py-1 rounded-md font-mono">0/0</span>
    <span id="filename" class="text-xs text-slate-600 font-medium truncate flex-1 text-center">—</span>
    <button onclick="undoBox()" class="px-3 py-1.5 text-xs font-semibold bg-white border border-slate-200 text-slate-700 hover:border-amber-400 hover:text-slate-900 rounded-lg transition-all duration-300">
      <i class="fa-solid fa-rotate-left mr-1 text-[10px]"></i> Undo
    </button>
    <button onclick="clearBoxes()" class="px-3 py-1.5 text-xs font-semibold bg-white border border-red-200 text-red-600 hover:bg-red-50 rounded-lg transition-all duration-300">
      <i class="fa-solid fa-trash-can mr-1 text-[10px]"></i> Clear
    </button>
    <button onclick="nextImage()" class="px-3 py-1.5 text-xs font-semibold bg-white border border-slate-200 text-slate-700 hover:border-amber-400 hover:text-slate-900 rounded-lg transition-all duration-300">
      Next <i class="fa-solid fa-arrow-right ml-1 text-[10px]"></i>
    </button>
  </div>

  <!-- Main layout -->
  <div class="flex flex-1 overflow-hidden">

    <!-- Sidebar -->
    <div class="w-60 bg-white border-r border-slate-100 flex flex-col shrink-0 overflow-y-auto">

      <!-- Classes -->
      <div class="p-4 border-b border-slate-100">
        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Classes</h3>
        <div id="class-list" class="space-y-1"></div>
        <div class="flex gap-1.5 mt-3">
          <input type="text" id="new-class-input" placeholder="New class…"
                 onkeydown="if(event.key==='Enter'){event.preventDefault();addNewClass();}"
                 class="flex-1 px-2.5 py-1.5 border border-slate-200 rounded-lg text-xs text-slate-900 placeholder:text-slate-400 focus:outline-none focus:border-amber-400 focus:ring-1 focus:ring-amber-400 transition-colors duration-200">
          <button onclick="addNewClass()" class="btn-brand-sm !px-3 !py-1.5">
            <i class="fa-solid fa-plus text-[10px]"></i>
          </button>
        </div>
      </div>

      <!-- Progress -->
      <div class="p-4 border-b border-slate-100">
        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Progress</h3>
        <div class="w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
          <div id="progress-fill" class="h-full rounded-full transition-all" style="width:0%;background:linear-gradient(to right,#f59e0b,#fb923c,#fcd34d);"></div>
        </div>
        <p id="progress-text" class="text-[11px] text-slate-400 mt-1.5">0/0 labeled</p>
      </div>

      <!-- Actions -->
      <div class="p-4 space-y-2">
        <button onclick="saveLabels()" class="btn-brand-sm w-full !py-2">
          <i class="fa-solid fa-floppy-disk mr-1.5"></i> Save Labels
        </button>
        <button onclick="downloadZip()" class="w-full py-2 bg-white border border-slate-200 text-slate-700 rounded-xl text-xs font-semibold hover:border-amber-400 hover:text-slate-900 transition-all duration-300 flex items-center justify-center gap-1.5">
          <i class="fa-solid fa-download text-[10px]"></i> Download ZIP
        </button>
        <a href="/" class="block w-full py-2 bg-white border border-slate-200 text-slate-700 rounded-xl text-xs font-semibold hover:border-amber-400 hover:text-slate-900 transition-all duration-300 text-center">
          <i class="fa-solid fa-arrow-left text-[10px] mr-1"></i> Home
        </a>
      </div>
    </div>

    <!-- Canvas Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Drawing indicator -->
      <div class="flex items-center justify-center gap-2 py-1.5 bg-white border-b border-slate-100">
        <span class="text-[11px] text-slate-400">Drawing:</span>
        <span id="indicator-dot" class="w-2.5 h-2.5 rounded-full" style="background:#f59e0b;"></span>
        <span id="indicator-name" class="text-xs font-semibold text-slate-700">—</span>
        <span class="text-[10px] text-slate-300 ml-2">Click &amp; drag to draw · Right-click to delete</span>
      </div>

      <!-- Canvas -->
      <div id="canvas-wrap" class="flex-1 flex items-center justify-center bg-slate-100 overflow-hidden">
        <canvas id="canvas"></canvas>
      </div>

      <!-- Box list -->
      <div id="box-list" class="max-h-36 overflow-y-auto bg-white border-t border-slate-200 divide-y divide-slate-100">
        <div class="px-4 py-3 text-xs text-slate-400 text-center">Draw a bounding box on the image above</div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast fixed bottom-6 right-6 px-6 py-3 rounded-xl text-sm font-semibold shadow-lg shadow-amber-400/30 opacity-0 translate-y-2 pointer-events-none z-50" style="background:linear-gradient(to right,#f59e0b,#fb923c,#fcd34d);color:#000;border:1px solid #000;"></div>

  <script>
const IMAGES_DIR = {{ images_dir | tojson }};
let CLASSES = {{ classes | tojson }};
const COLORS = ['#f59e0b','#ef4444','#3b82f6','#22c55e','#06b6d4','#a855f7','#f97316','#ec4899','#14b8a6','#8b5cf6','#84cc16','#f43f5e','#0ea5e9','#d946ef','#fb923c','#64748b'];

let images = [], currentIdx = 0, currentClass = 0, boxes = [];
let drawing = false, startX = 0, startY = 0, curX = 0, curY = 0;
let imgObj = new Image(), scale = 1, labeledSet = new Set();
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

/* ── Init ── */
async function init() {
  const resp = await fetch('/api/images?dir=' + encodeURIComponent(IMAGES_DIR));
  const data = await resp.json();
  images = data.images;
  labeledSet = new Set(data.labeled);
  renderClasses(); updateProgress();
  if (images.length > 0) loadImage(0);
  else document.getElementById('filename').textContent = 'No images found';
}

/* ── Classes ── */
function renderClasses() {
  const el = document.getElementById('class-list');
  el.innerHTML = '';
  CLASSES.forEach((cls, i) => {
    const color = COLORS[i % COLORS.length];
    const active = i === currentClass;
    const btn = document.createElement('button');
    btn.className = `flex items-center gap-2 w-full px-3 py-2 rounded-lg text-xs font-medium transition-all duration-300 ${active ? 'bg-amber-50 ring-2 ring-amber-400 shadow-sm' : 'hover:bg-slate-50'}`;
    btn.innerHTML = `<span class="w-2.5 h-2.5 rounded-full shrink-0" style="background:${color}"></span>
      <span class="flex-1 text-left text-slate-700">${cls}</span>
      <span class="text-[10px] text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">${i+1}</span>`;
    btn.onclick = () => { currentClass = i; renderClasses(); updateIndicator(); };
    el.appendChild(btn);
  });
  updateIndicator();
}

function updateIndicator() {
  if (!CLASSES.length) return;
  document.getElementById('indicator-dot').style.background = COLORS[currentClass % COLORS.length];
  document.getElementById('indicator-name').textContent = CLASSES[currentClass] || '—';
}

async function addNewClass() {
  const inp = document.getElementById('new-class-input');
  const v = inp.value.trim();
  if (!v || CLASSES.includes(v)) return;
  CLASSES.push(v); inp.value = '';
  renderClasses();
  await fetch('/api/classes?dir=' + encodeURIComponent(IMAGES_DIR), {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ classes: CLASSES }),
  });
  showToast("Class '" + v + "' added");
}

/* ── Load Image ── */
async function loadImage(idx) {
  if (idx < 0 || idx >= images.length) return;
  currentIdx = idx;
  const resp = await fetch('/api/labels/' + idx + '?dir=' + encodeURIComponent(IMAGES_DIR));
  boxes = (await resp.json()).boxes;
  imgObj = new Image();
  imgObj.onload = () => { fitCanvas(); render(); updateUI(); };
  imgObj.src = '/api/image/' + idx + '?dir=' + encodeURIComponent(IMAGES_DIR) + '&t=' + Date.now();
}

function fitCanvas() {
  const wrap = document.getElementById('canvas-wrap');
  const maxW = wrap.clientWidth - 32, maxH = wrap.clientHeight - 32;
  scale = Math.min(maxW / imgObj.width, maxH / imgObj.height, 1.0);
  canvas.width = Math.round(imgObj.width * scale);
  canvas.height = Math.round(imgObj.height * scale);
}

/* ── Render ── */
function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(imgObj, 0, 0, canvas.width, canvas.height);
  boxes.forEach((box, i) => {
    const color = COLORS[box.class_id % COLORS.length];
    const x = (box.cx - box.w/2) * canvas.width, y = (box.cy - box.h/2) * canvas.height;
    const w = box.w * canvas.width, h = box.h * canvas.height;
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.strokeRect(x, y, w, h);
    const label = CLASSES[box.class_id] || ('class_' + box.class_id);
    ctx.font = '600 11px Outfit, sans-serif';
    const tw = ctx.measureText(label).width;
    ctx.fillStyle = color; ctx.fillRect(x, y - 16, tw + 6, 16);
    ctx.fillStyle = '#fff'; ctx.fillText(label, x + 3, y - 4);
  });
  if (drawing) {
    const color = COLORS[currentClass % COLORS.length];
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.setLineDash([4, 4]);
    ctx.strokeRect(startX, startY, curX - startX, curY - startY);
    ctx.setLineDash([]);
    ctx.fillStyle = color + '18'; ctx.fillRect(startX, startY, curX - startX, curY - startY);
  }
}

/* ── Mouse ── */
canvas.addEventListener('mousedown', e => {
  if (e.button === 2) { e.preventDefault(); deleteNearest(e.offsetX, e.offsetY); return; }
  if (e.button === 0) { drawing = true; startX = e.offsetX; startY = e.offsetY; curX = startX; curY = startY; }
});
canvas.addEventListener('mousemove', e => { if (drawing) { curX = e.offsetX; curY = e.offsetY; render(); } });
canvas.addEventListener('mouseup', () => {
  if (!drawing) return; drawing = false;
  const x1 = Math.min(startX, curX), y1 = Math.min(startY, curY);
  const x2 = Math.max(startX, curX), y2 = Math.max(startY, curY);
  if (x2 - x1 < 5 || y2 - y1 < 5) return;
  boxes.push({ class_id: currentClass, cx: ((x1+x2)/2)/canvas.width, cy: ((y1+y2)/2)/canvas.height, w: (x2-x1)/canvas.width, h: (y2-y1)/canvas.height });
  render(); updateBoxList();
});
canvas.addEventListener('contextmenu', e => e.preventDefault());

function deleteNearest(mx, my) {
  if (!boxes.length) return;
  let minD = Infinity, minI = -1;
  boxes.forEach((b, i) => { const d = Math.hypot(b.cx*canvas.width - mx, b.cy*canvas.height - my); if (d < minD) { minD = d; minI = i; } });
  if (minI >= 0) { boxes.splice(minI, 1); render(); updateBoxList(); }
}

/* ── Keyboard ── */
document.addEventListener('keydown', e => {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key >= '1' && e.key <= '9') { const i = parseInt(e.key) - 1; if (i < CLASSES.length) { currentClass = i; renderClasses(); } }
  else if (e.key === 'd' || e.key === 'ArrowRight') nextImage();
  else if (e.key === 'a' || e.key === 'ArrowLeft') prevImage();
  else if (e.key === 's') saveLabels();
  else if (e.key === 'z') undoBox();
  else if (e.key === 'c' && !e.ctrlKey) clearBoxes();
});

/* ── Nav ── */
async function nextImage() { await saveLabels(true); if (currentIdx < images.length - 1) loadImage(currentIdx + 1); }
async function prevImage() { await saveLabels(true); if (currentIdx > 0) loadImage(currentIdx - 1); }

/* ── Save ── */
async function saveLabels(silent) {
  await fetch('/api/labels/' + currentIdx + '?dir=' + encodeURIComponent(IMAGES_DIR), {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ boxes }),
  });
  if (boxes.length > 0) labeledSet.add(images[currentIdx].name);
  updateProgress();
  if (!silent) showToast('Labels saved!');
}

function undoBox() { if (boxes.length) { boxes.pop(); render(); updateBoxList(); } }
function clearBoxes() { boxes = []; render(); updateBoxList(); }
function downloadZip() { saveLabels(true).then(() => { window.location.href = '/api/download_zip?dir=' + encodeURIComponent(IMAGES_DIR); }); }

/* ── UI ── */
function updateUI() {
  document.getElementById('counter').textContent = (currentIdx + 1) + '/' + images.length;
  document.getElementById('filename').textContent = images[currentIdx].name;
  updateBoxList(); updateProgress();
}

function updateBoxList() {
  const el = document.getElementById('box-list');
  if (!boxes.length) { el.innerHTML = '<div class="px-4 py-3 text-xs text-slate-400 text-center">Draw a bounding box on the image above</div>'; return; }
  el.innerHTML = boxes.map((b, i) => {
    const color = COLORS[b.class_id % COLORS.length];
    const cls = CLASSES[b.class_id] || ('class_' + b.class_id);
    const yolo = b.class_id + ' ' + b.cx.toFixed(4) + ' ' + b.cy.toFixed(4) + ' ' + b.w.toFixed(4) + ' ' + b.h.toFixed(4);
    return `<div class="flex items-center gap-2 px-4 py-1.5 text-xs hover:bg-slate-50 transition-colors">
      <span class="w-2 h-2 rounded-sm shrink-0" style="background:${color}"></span>
      <span class="font-medium text-slate-700 w-16">${cls}</span>
      <span class="text-slate-400 font-mono text-[11px] flex-1">${yolo}</span>
      <button onclick="boxes.splice(${i},1);render();updateBoxList();" class="text-slate-300 hover:text-red-500 leading-none transition-colors"><i class="fa-solid fa-xmark text-[10px]"></i></button>
    </div>`;
  }).join('');
}

function updateProgress() {
  const total = images.length, labeled = labeledSet.size;
  const pct = total > 0 ? (labeled / total * 100) : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
  document.getElementById('progress-text').textContent = labeled + '/' + total + ' labeled (' + Math.round(pct) + '%)';
}

window.addEventListener('resize', () => { if (imgObj.complete && imgObj.naturalWidth > 0) { fitCanvas(); render(); } });
init();
  </script>
</body>
</html>
